<html>
  <head>
    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/compile.js"></script>
    <script type="text/javascript" src="js/text.js"></script>
  </head>
  <body>
    <a href="#" onclick="start()"><img src="img/mic.png" /></a>
    <a href="#" onclick="stop()">Stop Mic</a>
    <a href="#" onclick="handleSpeech()">Compile</a>
    <!--<textarea id="textarea"></textarea>-->
    <div id="results">
      <span class="final" id="final_span"></span> <span class="interim" id="interim_span"></span>
    </div>
    <div id="pdf"></div>
  </body>
  <script type="text/javascript">

    var final_transcript;

    var recognition = new webkitSpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = "en";

    function start() {
      final_transcript = "";
      recognition.start();
    }

    function stop() {
      recognition.stop();
    }

    /*recognition.onresult = function (event) {
      for (var i = event.resultIndex; i < event.results.length; ++i) {
          if (!(event.results[i].isFinal)) {
              var text = event.results[i][0].transcript;
              insertAtCaret('textarea', text);
              speech+= text;
          }
      }
    }*/

    function insertAtCaret(id, text) {
      document.getElementById(id).value = text;
    }

    function handleSpeech() {
      convertText(speech);
    }

    var two_line = /\n\n/g;
    var one_line = /\n/g;
    function linebreak(s) {
      return s.replace(two_line, '<p></p>').replace(one_line, '<br>');
    }

    recognition.onresult = function(event) {
      var interim_transcript = '';

      for (var i = event.resultIndex; i < event.results.length; ++i) {
        if (event.results[i].isFinal) {
          final_transcript += event.results[i][0].transcript;
        } else {
          interim_transcript += event.results[i][0].transcript;
        }
      }

      final_span.innerHTML = linebreak(final_transcript);
      interim_span.innerHTML = linebreak(interim_transcript);
    };

/*    recognition.onresult = function (event) {
      // Calculating and saving the cursor position where the text will be displayed
      textArea = document.getElementById('textarea');
      var pos = textArea.getCursorPosition() - interimResult.length;
      // Deleting an interim result from the textArea field
      textArea.val(textArea.val().replace(interimResult, ''));
      interimResult = '';
      // Restoring the cursor position
      textArea.setCursorPosition(pos);
      for (var i = event.resultIndex; i < event.results.length; ++i) {
        if (event.results[i].isFinal) {
            insertAtCaret('textarea', event.results[i][0].transcript);
        } else {
            // Outputting the interim result to the text field and adding
            // an interim result marker - 0-length space
            insertAtCaret('textarea', event.results[i][0].transcript + '\u200B');
            interimResult += event.results[i][0].transcript + '\u200B';
        }
      }
    };
*/
  </script>
</html>
